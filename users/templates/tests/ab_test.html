<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AB test</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'styles/styles.css' %}">
</head>
<body>
    <form id="toolbar">
        <a href="{% url 'home' %}">Назад</a>
        <button type="button" id="loadImage">Load Image</button>
        <button type="button" id="loadTest">Load Test</button>
        <button type="button" id="prevImage">Previous</button>
        <button type="button" id="nextImage">Next</button>
        <button type="button" id="saveProject">Save Project</button>
        <a href="{% url 'my_tests' %}" class="button">My Tests</a>
    </form>
    <div id="imageContainer"></div>
    <input type="file" id="imageInput" accept="image/png" style="display: none;">
    <input type="file" id="loadTestInput" accept=".json" style="display: none;">
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
        {% if test_data %}
            loadProject({{ test_data|safe }});
        {% endif %}
    });

        let imageLabels = [];
        let currentImageIndex = -1;
        let mode = "author";
        const imageContainer = document.getElementById('imageContainer');
        const loadImageButton = document.getElementById('loadImage');
        const loadTestButton = document.getElementById('loadTest');
        const prevImageButton = document.getElementById('prevImage');
        const nextImageButton = document.getElementById('nextImage');
        const saveProjectButton = document.getElementById('saveProject');
        const imageInput = document.getElementById('imageInput');
        const loadTestInput = document.getElementById('loadTestInput');

        loadImageButton.addEventListener('click', () => imageInput.click());
        loadTestButton.addEventListener('click', () => loadTestFromServer(1)); // Replace 1 with the appropriate test ID
        prevImageButton.addEventListener('click', prevImage);
        nextImageButton.addEventListener('click', nextImage);
        saveProjectButton.addEventListener('click', saveProject);
        document.querySelectorAll('input[name="mode"]').forEach(radio => {
            radio.addEventListener('change', (e) => mode = e.target.value);
        });

        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        addImageLabel(img);
                    };
                };
                reader.readAsDataURL(file);
            }
        });

        loadTestInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = JSON.parse(e.target.result);
                    loadProject(data);
                };
                reader.readAsText(file);
            }
        });

        function addImageLabel(img) {
            imageLabels.push({ img, rectangles: [], points: [] });
            if (currentImageIndex !== -1) {
                imageLabels[currentImageIndex].img.style.display = 'none';
            }
            currentImageIndex = imageLabels.length - 1;
            renderCurrentImage();
        }

        function renderCurrentImage() {
            imageContainer.innerHTML = '';
            const currentLabel = imageLabels[currentImageIndex];
            imageContainer.appendChild(currentLabel.img);
            currentLabel.img.style.display = 'block';
            currentLabel.img.addEventListener('mousedown', onMouseDown);
            currentLabel.img.addEventListener('mouseup', onMouseUp);
            currentLabel.img.addEventListener('mousemove', onMouseMove);
            currentLabel.img.addEventListener('dragstart', (e) => e.preventDefault()); // Prevent image drag
            drawAnnotations(currentLabel);
        }

        function drawAnnotations(label) {
            {% if user_role == 'author' %}
            label.rectangles.forEach(rect => {
                const rectDiv = document.createElement('div');
                rectDiv.className = 'rectangle';
                rectDiv.style.left = `${rect.left}px`;
                rectDiv.style.top = `${rect.top}px`;
                rectDiv.style.width = `${rect.width}px`;
                rectDiv.style.height = `${rect.height}px`;
                imageContainer.appendChild(rectDiv);
            });
            {% endif %}

            label.points.forEach(point => {
                const pointDiv = document.createElement('div');
                pointDiv.className = 'point';
                pointDiv.style.left = `${point.x - 4}px`; // Center the point
                pointDiv.style.top = `${point.y - 4}px`; // Center the point
                imageContainer.appendChild(pointDiv);
            });
        }

        let drawing = false;
        let startX, startY;
        let currentRectDiv = null;

        function onMouseDown(e) {
            {% if user_role == 'author' %}
            drawing = true;
            startX = e.offsetX;
            startY = e.offsetY;
            currentRectDiv = document.createElement('div');
            currentRectDiv.className = 'rectangle';
            currentRectDiv.style.left = `${startX}px`;
            currentRectDiv.style.top = `${startY}px`;
            imageContainer.appendChild(currentRectDiv);
            {% endif %}
            {% if user_role == 'tester' %}
            const point = { x: e.offsetX, y: e.offsetY };
            imageLabels[currentImageIndex].points.push(point);
            drawAnnotations(imageLabels[currentImageIndex]);
            if (isPointInRectangles(point, imageLabels[currentImageIndex].rectangles)) {
                nextImage();
            }
            {% endif %}
        }

        function onMouseMove(e) {
            {% if user_role == 'author' %}
            if (drawing) {
                const currentX = e.offsetX;
                const currentY = e.offsetY;
                currentRectDiv.style.left = `${Math.min(startX, currentX)}px`;
                currentRectDiv.style.top = `${Math.min(startY, currentY)}px`;
                currentRectDiv.style.width = `${Math.abs(currentX - startX)}px`;
                currentRectDiv.style.height = `${Math.abs(currentY - startY)}px`;
            }
            {% endif %}
        }

        function onMouseUp(e) {
            {% if user_role == 'author' %}
            if (drawing) {
                drawing = false;
                const rect = {
                    left: Math.min(startX, e.offsetX),
                    top: Math.min(startY, e.offsetY),
                    width: Math.abs(e.offsetX - startX),
                    height: Math.abs(e.offsetY - startY)
                };
                imageLabels[currentImageIndex].rectangles.push(rect);
                drawAnnotations(imageLabels[currentImageIndex]);
                currentRectDiv = null;
            }
            {% endif %}
        }

        function isPointInRectangles(point, rectangles) {
            return rectangles.some(rect => {
                return point.x >= rect.left &&
                       point.x <= rect.left + rect.width &&
                       point.y >= rect.top &&
                       point.y <= rect.top + rect.height;
            });
        }

        function prevImage() {
            if (currentImageIndex > 0) {
                imageLabels[currentImageIndex].img.style.display = 'none';
                currentImageIndex--;
                renderCurrentImage();
            }
        }

        function nextImage() {
            if (currentImageIndex < imageLabels.length - 1) {
                imageLabels[currentImageIndex].img.style.display = 'none';
                currentImageIndex++;
                renderCurrentImage();
            }
        }

        function saveProject() {
            const data = imageLabels.map(label => {
                const canvas = document.createElement('canvas');
                canvas.width = label.img.width;
                canvas.height = label.img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(label.img, 0, 0);
                const imageBase64 = canvas.toDataURL('image/png').split(',')[1];
                return {
                    image: imageBase64,
                    rectangles: label.rectangles,
                    points: label.points
                };
            });

            fetch('{% url 'save_test' %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
                if (data.status === 'success') {
                    alert('Test saved successfully!');
                } else {
                    alert('Failed to save test.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while saving the test.');
            });
        }

                document.addEventListener('DOMContentLoaded', () => {
            const testLinks = document.querySelectorAll('.test-link');
            testLinks.forEach(link => {
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    const testId = event.target.getAttribute('data-test-id');
                    fetch(`/load_test/${testId}/`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Assuming you have a function to load the project data
                            loadProject(data.data);
                        } else {
                            alert('Failed to load test.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while loading the test.');
                    });
                });
            });
        });

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

function loadProject(data) {
    console.log('Loading project with data:', data);
    imageLabels = data.map(item => {
        const img = new Image();
        img.src = 'data:image/png;base64,' + item.image;
        return {
            img,
            rectangles: item.rectangles,
            points: item.points
        };
    });
    console.log('Image labels:', imageLabels);
    if (imageLabels.length > 0) {
        currentImageIndex = 0;
        renderCurrentImage();
    } else {
        console.error('No images to load');
    }
}
    </script>
</body>
</html>
